name: Release

on:
  release:
    types: [published]

jobs:
  test:
    name: Run Tests
    uses: ./.github/workflows/test.yml
    with:
      go-version: '1.23'  # Use latest stable or specific version
      run-integration-tests: true
    secrets: inherit

  sbom:
    name: Generate SBOM
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
      - name: Generate CycloneDX SBOM
        run: |
          go install github.com/CycloneDX/cyclonedx-gomod@latest
          cyclonedx-gomod mod -licenses -output sbom.cyclonedx.json
      - name: Generate SPDX SBOM
        run: |
          go install github.com/anchore/syft/cmd/syft@latest
          syft packages dir:. -o spdx-json -o file=sbom.spdx.json
      - name: Upload CycloneDX SBOM
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: sbom.cyclonedx.json
          asset_name: sbom.cyclonedx.json
          asset_content_type: application/json
      - name: Upload SPDX SBOM
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: sbom.spdx.json
          asset_name: sbom.spdx.json
          asset_content_type: application/json

  changelog:
    name: Generate Changelog
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
      - name: Install git-chglog
        run: go install github.com/git-chglog/git-chglog/cmd/git-chglog@latest
      - name: Generate changelog
        run: git-chglog -o CHANGELOG.md ${{ github.event.release.tag_name }}
      - name: Update release notes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: changelog
            });

  publish:
    name: Verify Release
    needs: [test, sbom, changelog]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
      - name: Verify go.mod
        run: go mod verify
      - name: Verify tag format
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Error: Tag $TAG does not match semver format (vX.Y.Z)"
            exit 1
          fi
      - name: Verify tag exists
        run: |
          git fetch --tags
          if ! git rev-parse "${{ github.event.release.tag_name }}" >/dev/null 2>&1; then
            echo "Error: Tag ${{ github.event.release.tag_name }} not found"
            exit 1
          fi
          echo "Tag verified: ${{ github.event.release.tag_name }}"
      - name: Verify module
        run: go mod tidy && git diff --exit-code go.mod go.sum
